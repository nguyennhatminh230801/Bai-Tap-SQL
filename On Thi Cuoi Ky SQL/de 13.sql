CREATE DATABASE QLTV

USE QLTV

CREATE TABLE SACH(
    MASACH NCHAR(20) PRIMARY KEY,
    TENSACH NVARCHAR(50),
    SOTRANG INT,
    SLTON INT
)

CREATE TABLE PM(
    MAPM NCHAR(20) PRIMARY KEY,
    NGAYM DATE,
    HOTENDG NVARCHAR(50)
)

CREATE TABLE SACHMUON(
    MASACH NCHAR(20),
    MAPM NCHAR(20),
    SONGAYMUON INT

    CONSTRAINT PK_MASACH_MAPM PRIMARY KEY(MASACH, MAPM),
    CONSTRAINT FK_MASACH FOREIGN KEY(MASACH) REFERENCES SACH(MASACH),
    CONSTRAINT FK_MAPM FOREIGN KEY(MAPM) REFERENCES PM(MAPM)
)

INSERT INTO SACH VALUES
(N'S01', N'SÁCH 1', 150, 50),
(N'S02', N'SÁCH 2', 200, 50)

INSERT INTO PM VALUES
(N'PM01', '2021-5-27', N'MINH'),
(N'PM02', '2021-4-19', N'NAM')

INSERT INTO SACHMUON VALUES
(N'S01', N'PM01', 50),
(N'S01', N'PM02', 30),
(N'S02', N'PM01', 40),
(N'S02', N'PM02', 60)

SELECT * FROM SACH
SELECT * FROM PM
SELECT * FROM SACHMUON

--CAU 2

ALTER VIEW CAU2
AS
    SELECT MASACH, SACHMUON.MAPM, DATEADD(DAY, SONGAYMUON, NGAYM) AS NGAYHETHAN
    FROM SACHMUON INNER JOIN PM
    ON SACHMUON.MAPM = PM.MAPM
    WHERE DATEADD(DAY, SONGAYMUON, NGAYM) <= GETDATE()

SELECT * FROM CAU2


--CAU 3
ALTER FUNCTION CAU3(@MASACH NCHAR(20))
RETURNS NVARCHAR(50)
AS
    BEGIN
        DECLARE @TENSACH NVARCHAR(50) = (
            SELECT TENSACH
            FROM SACH
            WHERE (SELECT COUNT(*) FROM SACHMUON WHERE MASACH = @MASACH) = 0
        )

        IF(@TENSACH IS NULL)
            BEGIN
                SET @TENSACH = N'Sách Đã Được Mượn'
            END
        RETURN @TENSACH
    END

SELECT dbo.CAU3('S02') as ANSWER


CREATE TRIGGER CAU4
ON SACHMUON
FOR INSERT
AS  
    BEGIN
        UPDATE SACH
        SET SLTON = SLTON - 1
        FROM SACH INNER JOIN inserted
        on SACH.MASACH = inserted.MASACH
    END

INSERT INto SACH(MASACH, SLTON) VALUES (N'S03', 1000)
INSERT INTO SACHMUON VALUES(N'S03', N'PM01', 20)

SELECT * FROM SACH
SELECT * FROM SACHMUON